var B=Object.defineProperty;var D=(a,s,t)=>s in a?B(a,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[s]=t;var T=(a,s,t)=>D(a,typeof s!="symbol"?s+"":s,t);import{c as R,r as o,f as W,j as e,g as V,B as p,L as z,h as G,u as H,C as Q,b as A,A as X,d as _,e as J}from"./index-B4xvOnNy.js";import{X as O}from"./x-RsUUIv3D.js";import{M as K,C as Y,P as Z}from"./ProgressBar-DtIsliQW.js";import{I as F}from"./Input-_lfaPETx.js";/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const q=R("ChevronLeft",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=R("ChevronRight",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]]);/**
 * @license lucide-react v0.344.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=R("Save",[["path",{d:"M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z",key:"1owoqh"}],["polyline",{points:"17 21 17 13 7 13 7 21",key:"1md35c"}],["polyline",{points:"7 3 7 8 15 8",key:"8nz8an"}]]);function M({isOpen:a,onClose:s,children:t,title:r,size:i="md",closeOnOverlayClick:l=!0,showCloseButton:d=!0}){if(o.useEffect(()=>(a?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[a]),o.useEffect(()=>{const n=h=>{h.key==="Escape"&&s()};return a&&document.addEventListener("keydown",n),()=>{document.removeEventListener("keydown",n)}},[a,s]),!a)return null;const m=n=>{n.target===n.currentTarget&&l&&s()};return W.createPortal(e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 p-4",onClick:m,children:e.jsxs("div",{className:V("relative w-full rounded-lg bg-white shadow-xl",{"max-w-sm":i==="sm","max-w-md":i==="md","max-w-lg":i==="lg","max-w-4xl":i==="xl"}),children:[(r||d)&&e.jsxs("div",{className:"flex items-center justify-between border-b border-gray-200 p-6",children:[r&&e.jsx("h2",{className:"text-lg font-semibold text-gray-900",children:r}),d&&e.jsx(p,{variant:"ghost",size:"sm",onClick:s,leftIcon:e.jsx(O,{className:"h-4 w-4"}),className:"ml-auto",children:e.jsx("span",{className:"sr-only",children:"Close"})})]}),e.jsx("div",{className:"p-6",children:t})]})}),document.body)}function te(a){const s=Math.floor(a/3600),t=Math.floor(a%3600/60),r=a%60,i=l=>l.toString().padStart(2,"0");return`${i(s)}:${i(t)}:${i(r)}`}function ae({question:a,onAnswer:s,currentAnswer:t,showFeedback:r=!1}){const[i,l]=o.useState(t),[d,m]=o.useState(!1);o.useEffect(()=>{l(t)},[t]);const n=u=>{l(u),s(u)},h=r&&i===a.correctAnswer;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"relative aspect-video w-full overflow-hidden rounded-lg bg-gray-100",children:[!d&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(z,{})}),e.jsx("img",{src:a.imageUrl,alt:"Pregunta",className:`h-full w-full object-contain transition-opacity duration-300 ${d?"opacity-100":"opacity-0"}`,onLoad:()=>m(!0),onError:()=>m(!0)})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-lg font-medium text-gray-900",children:a.text}),e.jsx("div",{className:"grid gap-3",children:a.options.map((u,v)=>e.jsxs(p,{variant:i===u?"primary":"outline",className:`justify-start text-left ${r&&u===a.correctAnswer&&"bg-green-100 text-green-800 hover:bg-green-200"}`,onClick:()=>n(u),children:[e.jsxs("span",{className:"mr-3 font-semibold",children:[String.fromCharCode(65+v),"."]}),u]},v))})]}),r&&i&&e.jsx("div",{className:`mt-4 rounded-lg p-4 ${h?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:h?"¡Respuesta correcta!":"Respuesta incorrecta"})]})}function re({question:a,onAnswer:s,currentAnswers:t={}}){const[r,i]=o.useState(t),[l,d]=o.useState(!1);o.useEffect(()=>{i(t)},[t]);const m=(n,h)=>{const u={...r,[n]:h};i(u),s(u)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"relative aspect-video w-full overflow-hidden rounded-lg bg-gray-100",children:[!l&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(z,{})}),e.jsx("img",{src:a.imageUrl,alt:"Pregunta",className:`h-full w-full object-contain transition-opacity duration-300 ${l?"opacity-100":"opacity-0"}`,onLoad:()=>d(!0),onError:()=>d(!0)})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-lg font-medium text-gray-900",children:a.text}),e.jsx("div",{className:"grid gap-4",children:a.fields.map(n=>e.jsx(F,{label:n.label,placeholder:n.placeholder,value:r[n.id]||"",onChange:h=>m(n.id,h.target.value),error:n.required&&!r[n.id]?"Este campo es requerido":void 0,isRequired:n.required},n.id))})]})]})}function ne({question:a,onAnswer:s,currentAnswer:t,showFeedback:r=!1}){const[i,l]=o.useState(t);o.useEffect(()=>{l(t)},[t]);const d=n=>{l(n),s(n)},m=r&&i===a.correctAnswer;return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-lg font-medium text-gray-900",children:a.text}),e.jsx("div",{className:"grid gap-3",children:a.options.map((n,h)=>e.jsxs(p,{variant:i===n?"primary":"outline",className:`justify-start text-left ${r&&n===a.correctAnswer&&"bg-green-100 text-green-800 hover:bg-green-200"}`,onClick:()=>d(n),children:[e.jsxs("span",{className:"mr-3 font-semibold",children:[String.fromCharCode(65+h),"."]}),n]},h))}),r&&i&&a.feedback&&e.jsx("div",{className:`mt-4 rounded-lg p-4 ${m?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:m?a.feedback.correct:a.feedback.incorrect})]})}function ie({question:a,onAnswer:s,currentPairs:t={}}){var j;const[r,i]=o.useState(t),[l,d]=o.useState(null);o.useEffect(()=>{i(t)},[t]);const m=c=>{d(l===c?null:c)},n=c=>{if(!l)return;const x={...r};Object.entries(x).forEach(([g,b])=>{(g===l||b===c)&&delete x[g]}),x[l]=c,i(x),s(x),d(null)},h=c=>{const x={...r};delete x[c],i(x),s(x)},u=c=>c in r,v=c=>Object.values(r).includes(c);return e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-lg font-medium text-gray-900",children:a.text}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium text-gray-700",children:"Columna A"}),a.columnA.map(c=>e.jsx(p,{onClick:()=>m(c.id),variant:l===c.id?"primary":u(c.id)?"secondary":"outline",className:"w-full justify-start text-left",children:c.text},c.id))]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-medium text-gray-700",children:"Columna B"}),a.columnB.map(c=>e.jsx(p,{onClick:()=>n(c.id),variant:v(c.id)?"secondary":l?"outline":"ghost",disabled:v(c.id)&&!l,className:"w-full justify-start text-left",children:c.text},c.id))]})]}),Object.keys(r).length>0&&e.jsxs("div",{className:"mt-8",children:[e.jsx("h3",{className:"mb-4 font-medium text-gray-700",children:"Relaciones establecidas:"}),e.jsx("div",{className:"space-y-2",children:Object.entries(r).map(([c,x])=>{var g,b;return e.jsxs("div",{className:"flex items-center justify-between rounded-lg bg-gray-50 p-4",children:[e.jsxs("div",{className:"flex items-center flex-1",children:[e.jsx("span",{className:"flex-1",children:(g=a.columnA.find(C=>C.id===c))==null?void 0:g.text}),e.jsx("span",{className:"mx-4 text-gray-400",children:"→"}),e.jsx("span",{className:"flex-1",children:(b=a.columnB.find(C=>C.id===x))==null?void 0:b.text})]}),e.jsx(p,{variant:"ghost",size:"sm",onClick:()=>h(c),leftIcon:e.jsx(O,{className:"h-4 w-4"}),className:"ml-4 text-red-500 hover:text-red-700",children:e.jsx("span",{className:"sr-only",children:"Eliminar relación"})})]},c)})})]}),l&&e.jsxs("div",{className:"text-sm text-gray-600 bg-blue-50 p-3 rounded-lg",children:['Seleccionaste "',(j=a.columnA.find(c=>c.id===l))==null?void 0:j.text,'". Ahora selecciona un elemento de la Columna B para crear la relación.']})]})}function le({question:a,onAnswer:s,currentResponse:t,showFeedback:r=!1}){switch(a.type){case"image":return e.jsx(ae,{question:a,onAnswer:s,currentAnswer:t==null?void 0:t.answer,showFeedback:r});case"multiInput":return e.jsx(re,{question:a,onAnswer:s,currentAnswers:t==null?void 0:t.answer});case"multipleChoice":return e.jsx(ne,{question:a,onAnswer:s,currentAnswer:t==null?void 0:t.answer,showFeedback:r});case"matching":return e.jsx(ie,{question:a,onAnswer:s,currentPairs:t==null?void 0:t.answer});default:return e.jsxs("div",{className:"rounded-lg border border-red-200 bg-red-50 p-4 text-red-800",children:["Tipo de pregunta no soportado: ",a.type]})}}class I{constructor(s,t){this.metadata=s,this.progress=t}static create(s){const t={testId:s.id,currentQuestion:0,responses:new Map,timeRemaining:s.duration*60,lastSaved:new Date,isCompleted:!1};return new I(s,t)}updateProgress(s,t,r){const i={...this.progress,currentQuestion:s,responses:t,timeRemaining:r,lastSaved:new Date};return new I(this.metadata,i)}addResponse(s,t){const r={questionId:s,answer:t,timestamp:new Date},i=new Map(this.progress.responses);return i.set(s,r),this.updateProgress(this.progress.currentQuestion,i,this.progress.timeRemaining)}complete(){const s={...this.progress,isCompleted:!0,lastSaved:new Date};return new I(this.metadata,s)}getCompletionPercentage(){return this.progress.responses.size/this.metadata.totalQuestions*100}isTimeExpired(){return this.progress.timeRemaining<=0}shouldShowWarning(){return this.progress.timeRemaining<=300}}class ce{constructor(s){this.testRepository=s}async execute(s){const t=await this.testRepository.getTestById(s);if(t&&!t.progress.isCompleted)return t;const i=(await this.testRepository.getAvailableTests()).find(l=>l.id===s);if(!i)throw new Error(`Test with id ${s} not found`);return I.create(i)}}class oe{constructor(s){this.testRepository=s}async execute(s){if(s.progress.isCompleted)throw new Error("Cannot save progress for completed test");await this.testRepository.saveProgress(s)}}class de{constructor(s){this.testRepository=s}async execute(s){const t=s.complete();await this.testRepository.submitTest(t)}}class me{static validateResponse(s,t){switch(s.type){case"image":case"multipleChoice":return typeof t=="string"&&t.length>0;case"multiInput":if(typeof t!="object"||t===null)return!1;const r=t;return s.fields.filter(l=>l.required).every(l=>{var d;return((d=r[l.id])==null?void 0:d.trim().length)>0});case"matching":if(typeof t!="object"||t===null)return!1;const i=t;return s.columnA.length===Object.keys(i).length;default:return!1}}static isCorrect(s,t){switch(s.type){case"image":case"multipleChoice":return s.correctAnswer===t;case"matching":if(!s.correctPairs||typeof t!="object")return!1;const r=t;return Object.entries(s.correctPairs).every(([i,l])=>r[i]===l);default:return!0}}}class ue{execute(s,t,r){if(!me.validateResponse(t,r))throw new Error("Invalid answer format for question type");return s.addResponse(t.id,r)}}class he{constructor(){T(this,"intervalId",null);T(this,"remainingTime",0);T(this,"onTickCallback",null);T(this,"onCompleteCallback",null);T(this,"isPaused",!1)}start(s,t,r){this.stop(),this.remainingTime=s,this.onTickCallback=t,this.onCompleteCallback=r,this.isPaused=!1,this.intervalId=window.setInterval(()=>{var i,l;this.isPaused||(this.remainingTime--,(i=this.onTickCallback)==null||i.call(this,this.remainingTime),this.remainingTime<=0&&(this.stop(),(l=this.onCompleteCallback)==null||l.call(this)))},1e3)}pause(){this.isPaused=!0}resume(){this.isPaused=!1}stop(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null),this.onTickCallback=null,this.onCompleteCallback=null}getRemainingTime(){return this.remainingTime}}const P=new K,L=new he,xe=new ce(P),ge=new oe(P),fe=new de(P),pe=new ue;function je(a){const[s,t]=o.useState(null),[r,i]=o.useState([]),[l,d]=o.useState(0),[m,n]=o.useState(0),[h,u]=o.useState(!0),[v,j]=o.useState(!1),[c,x]=o.useState(null);o.useEffect(()=>{let f=!0;return(async()=>{if(!a){x("ID del test no válido"),u(!1);return}try{if(u(!0),x(null),!await P.exists(a))throw new Error("El test no existe o no está disponible");const N=await xe.execute(a),E=await P.getQuestions(a);if(!f)return;if(!N||!E.length)throw new Error("No se pudo cargar el test correctamente");t(N),i(E),d(N.progress.currentQuestion),n(N.progress.timeRemaining),L.start(N.progress.timeRemaining,n,()=>{C()})}catch(y){if(!f)return;console.error("Error initializing test:",y),x(y instanceof Error?y.message:"Error al cargar el test")}finally{f&&u(!1)}})(),()=>{f=!1,L.stop()}},[a]);const g=o.useCallback(async()=>{if(s)try{j(!0);const f=s.updateProgress(l,s.progress.responses,m);await ge.execute(f),t(f)}catch(f){console.error("Error saving progress:",f)}finally{j(!1)}},[s,l,m]),b=o.useCallback((f,k)=>{if(s)try{const y=pe.execute(s,f,k);t(y)}catch(y){console.error("Error answering question:",y)}},[s]),C=o.useCallback(async()=>{if(s)try{L.stop(),await fe.execute(s)}catch(f){console.error("Error submitting test:",f)}},[s]);return{test:s,questions:r,currentQuestionIndex:l,timeRemaining:m,loading:h,saving:v,error:c,setCurrentQuestionIndex:d,saveProgress:g,answerQuestion:b,submitTest:C}}const ve=300,ye=3e4,be=()=>{const{id:a}=G(),s=H(),[t,r]=o.useState(!1),[i,l]=o.useState(!1),{test:d,questions:m,currentQuestionIndex:n,loading:h,error:u,saving:v,timeRemaining:j,setCurrentQuestionIndex:c,answerQuestion:x,saveProgress:g,submitTest:b}=je(a);o.useEffect(()=>{j===ve&&r(!0)},[j]),o.useEffect(()=>{if(!d)return;const w=setInterval(()=>{g()},ye);return()=>clearInterval(w)},[d,g]),o.useEffect(()=>{j<=0&&k(!0)},[j]);const C=o.useCallback(async()=>{!m||n>=m.length-1||(await g(),c(n+1))},[m,n,g,c]),f=o.useCallback(async()=>{n<=0||(await g(),c(n-1))},[n,g,c]),k=o.useCallback(async(w=!1)=>{const S=w?"El tiempo ha terminado. Tu examen será enviado automáticamente.":"¿Estás seguro de que deseas enviar el examen?";(w||window.confirm(S))&&(await b(),s("/dashboard"))},[b,s]),y=o.useCallback(()=>{if(!d||!m)return;const w=m[n];return d.progress.responses.get(w.id)},[d,m,n]),N=o.useCallback(()=>d?d.progress.responses.size/d.metadata.totalQuestions*100:0,[d]);if(h)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"h-8 w-8 animate-spin rounded-full border-4 border-emerald-500 border-t-transparent mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Cargando examen..."})]})});if(u)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsx(Q,{className:"max-w-md",children:e.jsxs(A,{className:"text-center",children:[e.jsx("p",{className:"text-red-600 mb-4",children:u}),e.jsx(p,{onClick:()=>s("/dashboard"),children:"Volver al Dashboard"})]})})});if(!d||!m)return null;const E=m[n],U=n===m.length-1,$=n===0;return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(M,{isOpen:t,onClose:()=>r(!1),title:"¡Tiempo limitado!",size:"sm",children:e.jsxs("div",{className:"text-center",children:[e.jsx(X,{className:"h-12 w-12 text-amber-500 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Quedan menos de 5 minutos para completar el examen."}),e.jsx(p,{onClick:()=>r(!1),fullWidth:!0,children:"Entendido"})]})}),e.jsx(M,{isOpen:i,onClose:()=>l(!1),title:"Confirmar envío",size:"sm",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-gray-600 mb-6",children:"¿Estás seguro de que deseas enviar el examen? Esta acción no se puede deshacer."}),e.jsxs("div",{className:"flex space-x-4",children:[e.jsx(p,{variant:"outline",onClick:()=>l(!1),fullWidth:!0,children:"Cancelar"}),e.jsx(p,{onClick:()=>k(!1),fullWidth:!0,children:"Enviar examen"})]})]})}),e.jsxs("div",{className:"container mx-auto max-w-4xl py-8 px-4",children:[e.jsx(Q,{className:"mb-8",children:e.jsxs(_,{children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs(J,{children:["Pregunta ",n+1," de ",m.length]}),e.jsxs("div",{className:"flex items-center mt-2 text-sm text-gray-600",children:[e.jsx(Y,{className:"h-4 w-4 mr-1"}),"Tiempo restante: ",te(j)]})]}),e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx(p,{variant:"outline",size:"sm",onClick:g,disabled:v,leftIcon:e.jsx(se,{className:"h-4 w-4"}),children:v?"Guardando...":"Guardar"}),e.jsx(p,{onClick:()=>l(!0),size:"sm",variant:"destructive",children:"Finalizar examen"})]})]}),e.jsx("div",{className:"mt-4",children:e.jsx(Z,{value:N(),showLabel:!0,className:"w-full"})})]})}),e.jsx(Q,{className:"mb-8",children:e.jsx(A,{children:e.jsx(le,{question:E,onAnswer:w=>x(E,w),currentResponse:y()})})}),e.jsx(Q,{children:e.jsx(A,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(p,{onClick:f,disabled:$,variant:"outline",leftIcon:e.jsx(q,{className:"h-4 w-4"}),children:"Anterior"}),e.jsx("div",{className:"flex items-center space-x-2",children:m.map((w,S)=>e.jsx("button",{onClick:()=>c(S),className:`h-3 w-3 rounded-full transition-colors ${S===n?"bg-emerald-600":d.progress.responses.has(m[S].id)?"bg-emerald-200":"bg-gray-200"}`},S))}),e.jsx(p,{onClick:C,disabled:U,rightIcon:e.jsx(ee,{className:"h-4 w-4"}),children:"Siguiente"})]})})})]})]})};function ke(){return e.jsx(be,{})}export{ke as TestPage};
